{% extends 'layout.html' %}

{% block css %}
<style>
.text-title{
    font-size   : 18px;
    font-weight : 500;
    color       : #060816;
    font-family : "Poppins", sans-serif;
}
.overlayRecord{
    position: fixed;
    inset: 0;
    height: 100%;
    width: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 99999;
    display: flex;
    justify-content: center;
    align-items: center;
}
.overlayRecord audio{
    width: 40%;
}
.closeOverlay{
    position: absolute;
    right: 0;
    top: 0;
    margin: 15px
}

</style>

{% endblock %}

{% block body %}

{{ include("CallReports/modalFiltros.html") }}
{{ include("CallReports/overlayRecord.html") }}
<!-- <section class="section"> -->
    <div class="col-12 ">
        <div class="card ">
            <div class="card-header d-flex flex-row justify-content-between align-items-center">
                <span class="text-title">Relatório de ligações</span>
                <button id="btnFiltros" class="btn btn-outline-info " >Filtros</button>
            </div>
            <div class="card-body mt-4">
                <div class="row table-responsive">
                    
                    <table id="tableCallReports" class="table table-sm table-striped table-bordered w-100"></table>
                </div>
            </div>
        </div>
    </div>
<!-- </section> -->
{% endblock %}


{% block js %}

<script>

let filtros = new bootstrap.Modal("#modalFiltros", modalOption);

$(function(){
    $('#data_de').datepicker({
        endDate: new Date(),
        todayBtn: "linked",
        todayHighlight: true
    });
    $('#data_de').datepicker().on("changeDate", function({date}){
        $('#data_ate').datepicker("setStartDate", date)
    })

    $('#data_ate').datepicker({
        endDate: new Date(),
        startDate: new Date(),
        todayBtn: "linked",
        todayHighlight: true
    });

    $("#status,#origem, #destino").select2({
        width: '100%',
        dropdownParent: $('#modalFiltros'),
        closeOnSelect: false,
    });

    $("#btnFiltros").click(() => filtros.show() );

    $("#btnFiltrar").click(function(){
        GeraTabela();
        filtros.hide()
    })
    ModalDraggable();
    GeraTabela();
})


const GeraTabela = () => {
    let form = $("#formFiltro").serializeObject();
    $.ajax({url: '{{ route().link("lista-ligacoes") }}',method:"POST", data: form})
    .done(resp => {

        $('#tableCallReports').DataTable({
            columns: [
                { data: 'calldate',         title: "Data",        className: "text-center", render: renderFormataDataHora},
                { data: 'src',              title: "Origem",      className: "text-center", render: renderSrc, orderable: false },
                { data: 'dstchannel',       title: "Destino",     className: "text-center", render: renderDst , orderable: false },
                { data: 'time_duration',    title: "Duração",     className: "text-center", orderable: false },
                { data: 'protocolo',        title: "Protocolo",   className: "text-center", orderable: false },
                { data: 'status',           title: "Status",      className: "text-center", render: renderStatus },
                
                {% if CheckPermission(33) %}
                { data: 'status',           title: "Ação",      className: "text-center", render: renderAcoes },
                {% endif %}
            ],
            data: resp,
            order: [["0", 'asc']],
            destroy: true,
            buttons: ['pageLength', exportMenu('pdf', 'excelNumber')],
        });
    })
}

const renderSrc = (data, type, {src_name}) => {
    let src = src_name === null ? data : `${data} - (${src_name})`;

    return src;
}

const renderDst = (data, type, {dst_name, dst}) => {
    let dstRender
    if(dst_name){
        dstRender = `${data} - ${dst_name}`
    }else{
        if(!data){
            dstRender = data
        }else{
            dstRender = dst
        }
    }

    return dstRender;
}

const renderStatus = (data, type, {dstchannel}) => {
    let status = "";
    if(dstchannel === ""){
        status = `<span class="badge bg-danger">Parou na URA</span>`;
    }else{
        switch(data){
            case "NO ANSWER":
                status = `<span class="badge bg-danger">Não atendida</span>`;
            break;
            case "BUSY":
                status = `<span class="badge bg-warning">Ocupada</span>`;
            break;
    
            case "ANSWERED":
                status = `<span class="badge bg-success">Atendida</span>`;
            break;
        }
    }

    return status;
}

const renderAcoes = (data, type, {protocolo}) => {
    let botao = "";
    
    botao +=`
    <button title="Ouvir ligação" class="btn btn-primary btn-sm"
        onclick="ListenRecord(${protocolo})"
    >
        <i class="fa-regular fa-play"></i>
    </button> `

    return botao;
}

const ListenRecord = protocolo => {
    $.ajax({url: `{{ route().link("listen-recorded") }}${protocolo}`})
    .done(resp => {
        console.log(resp)
        $(".overlayRecord")
        .removeClass("d-none")
        .find("audio")
        .attr("src", resp.audio)
    })
}

$(".closeOverlay").click(function(){
    $(".overlayRecord")
    .addClass("d-none")
    .find("audio")
    .attr("src", "")
})

</script>

{% endblock %}
